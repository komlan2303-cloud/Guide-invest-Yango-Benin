<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
const { jsPDF } = window.jspdf;

/* ================= CONFIG ================= */
const PRO_CODES = {
 "JOSUE-MOMO-JOSUE": { owner:"Josue", max:200 }
};

const LANGS = ["Français","English","Español","Português","Русский","العربية","Hindi","中文"];

const CURRENCIES = {
 "FCFA": {rate:1, label:"FCFA"},
 "USD": {rate:600, label:"USD"},
 "EUR": {rate:655, label:"EUR"},
 "NGN": {rate:1.3, label:"NGN"},
 "GHS": {rate:50, label:"GHS"},
 "CNY": {rate:85, label:"CNY"},
 "RUB": {rate:6, label:"RUB"},
 "AED": {rate:165, label:"AED"},
 "INR": {rate:7.2, label:"INR"}
};

let currentCode=null;
let currency="FCFA";

/* ================= INIT ================= */
window.onload=()=>{
 LANGS.forEach(l=>langSelect.innerHTML+=`<option>${l}</option>`);
 Object.keys(CURRENCIES).forEach(c=>currencySelect.innerHTML+=`<option>${c}</option>`);
};

/* ================= ACCESS ================= */
function unlock(){
 const code=codeInput.value.trim();
 if(!PRO_CODES[code]) return alert("Code invalide");
 const store=JSON.parse(localStorage.getItem(code)||"{}");
 if((store.used||0)>=PRO_CODES[code].max) return alert("Limite atteinte");

 currentCode=code;
 loginCard.classList.add("hidden");
 dashboard.classList.remove("hidden");

 ownerName.innerText=PRO_CODES[code].owner;
 usedCount.innerText=store.used||0;
 remainingCount.innerText=PRO_CODES[code].max-(store.used||0);
 showTab('salariat');
}

/* ================= NAV ================= */
function showTab(id){
 ["salariat","leasing","compare","history"].forEach(t=>{
  document.getElementById(t).classList.add("hidden");
 });
 document.getElementById(id).classList.remove("hidden");
 document.querySelectorAll(".nav-btn").forEach(b=>b.classList.remove("active"));
}

/* ================= UTILS ================= */
function convert(v){
 return (v / CURRENCIES[currency].rate).toFixed(0)+" "+currency;
}

/* ================= SALARIAT ================= */
function calcSalariat(){
 currency=currencySelect.value;

 const nb=+s_nb.value;
 const charges=+s_salary.value+ +s_bonus.value+ +s_fuel.value+ +s_maint.value+ +s_misc.value;
 const profit=+s_rev.value - charges;
 const roi=+s_buy.value / profit;

 salariatResult.innerHTML=`
 <h3>Résultats – Salariat</h3>
 <p><b>Charges mensuelles :</b> ${convert(charges)}</p>
 <p><b>Résultat net par véhicule :</b> ${convert(profit)}</p>
 <p><b>Résultat total (${nb} véhicules) :</b> ${convert(profit*nb)}</p>
 <p><b>ROI estimé :</b> ${roi.toFixed(1)} mois</p>
 <hr>
 <b>Analyse :</b>
 <ul>
  <li>Rentabilité rapide</li>
  <li>Forte génération de cash</li>
  <li>Gestion rigoureuse indispensable</li>
 </ul>
 `;

 save("Salariat",{profit,roi});
}

/* ================= LEASING ================= */
function calcLeasing(){
 currency=currencySelect.value;

 const margin=+l_sell.value-+l_buy.value;
 const monthly=+l_sell.value/+l_months.value;
 const daily=monthly/+l_days.value;
 const roi=+l_buy.value/monthly;

 leasingResult.innerHTML=`
 <h3>Résultats – Leasing</h3>
 <p><b>Marge par véhicule :</b> ${convert(margin)}</p>
 <p><b>Paiement mensuel chauffeur :</b> ${convert(monthly)}</p>
 <p><b>Paiement journalier :</b> ${convert(daily)}</p>
 <p><b>ROI estimé :</b> ${roi.toFixed(1)} mois</p>
 <hr>
 <b>Analyse :</b>
 <ul>
  <li>Gestion simplifiée</li>
  <li>Risque transféré au chauffeur</li>
  <li>Revenus stables</li>
 </ul>
 `;
 save("Leasing",{margin,roi});
}

/* ================= COMPARAISON ================= */
function compare(){
 const h=JSON.parse(localStorage.getItem(currentCode)||"{}").history||[];
 const s=h.filter(x=>x.type==="Salariat").slice(-1)[0];
 const l=h.filter(x=>x.type==="Leasing").slice(-1)[0];

 if(!s||!l) return alert("Effectuez les deux simulations");

 compareResult.innerHTML=`
 <h3>Comparaison détaillée</h3>
 <p><b>ROI Salariat :</b> ${s.data.roi.toFixed(1)} mois</p>
 <p><b>ROI Leasing :</b> ${l.data.roi.toFixed(1)} mois</p>
 <hr>
 <b>Recommandation stratégique :</b><br>
 ${
  s.data.roi<l.data.roi
  ?"Salariat recommandé pour un retour rapide sur investissement."
  :"Leasing recommandé pour plus de sécurité et moins de gestion."
 }
 `;
}

/* ================= HISTORY ================= */
function save(type,data){
 const store=JSON.parse(localStorage.getItem(currentCode)||"{}");
 store.used=(store.used||0)+1;
 store.history=store.history||[];
 store.history.push({type,date:new Date().toLocaleString(),data});
 localStorage.setItem(currentCode,JSON.stringify(store));
 usedCount.innerText=store.used;
 remainingCount.innerText=PRO_CODES[currentCode].max-store.used;
}

/* ================= PDF ================= */
function downloadPDF(type){
 const doc=new jsPDF();
 doc.text("Yango Business Simulator – PRO",10,10);
 doc.text("Estimations basées sur Yango ECO",10,18);
 doc.text("Type : "+type,10,30);
 doc.text("Date : "+new Date().toLocaleString(),10,38);
 doc.text("Données issues de simulations réelles terrain.",10,50);
 doc.save("yango-"+type+".pdf");
}
</script>
